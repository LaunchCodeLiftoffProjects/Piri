<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org/">
<head th:replace="fragments :: head">
</head>
<body id="search-background">

<div th:if="${session.user}">
        <div th:replace="fragments :: header-authenticated" class="navbar navbar-inverse navbar-fixed-top"></div>
</div>
<div th:unless="${session.user}">
        <div th:replace="fragments :: header-anonymous" class="navbar navbar-inverse navbar-fixed-top"></div>
</div>

<div class="jumbotron">
        <div class="row">
                <div class="col-md-4">
<!--                        <div>-->
<!--                                <img src="/images/nycskyline.png" alt="..." class="img-fluid">-->
<!--                        </div>-->
                        <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
                                <div th:if="${city.images != null && city.images.size() > 0}">
                                        <div class="carousel-inner">
                                                <div class="carousel-item active">
                                                        <img class="d-block w-100" th:src="@{'data:image/jpeg;base64,' + ${city.getImages().get(0)}}" alt="First slide">
                                                </div>
                                                <div class="carousel-item" th:each="image : ${city.images}">
                                                        <img class="d-block w-100" th:src="@{'data:image/jpeg;base64,' + ${image}}" alt="Second slide">
                                                </div>
                                        </div>
                                        <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                <span class="sr-only">Previous</span>
                                        </a>
                                        <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                <span class="sr-only">Next</span>
                                        </a>
                                </div>
                                <div th:if="${city.images == null}">
                                        <img src="/images/default.jpg" alt="..." class="img-fluid">
                                </div>

                        </div>
                </div>
                <div class="col-md-4">
                        <div>
                                <h1 th:text="${city.cityName} +', ' +${city.stateName}" ></h1>
                                <div class="Stars"
                                     th:style="|--rating: ${overallRating}|" >
                                </div>
<!--                                <p th:text="'Overall rating is ' + ${overallRating} + ' based on ' + ${reviews.size()} + ' total reviews.'" ></p>-->
                                <p th:text="'Overall rating is ' + ${overallRating} + ' based on ' + ${sizeOfReviews} + ' total reviews.'" ></p>

                                <a th:href="@{'/review/' + ${city.id}}" >Write a Review</a>
                        </div>
                </div>
                <div class="col-md-4">
                        <div class = "nav justify-content-end">
                                <ul class="list-unstyled">
                                        <li>
                                                <form method="post" action="/save-city">
                                                        <label class="btn btn-success save-compare-btn" for="saveCity" >Save to
                                                                Favorites
                                                                <input type="submit" th:value="${city.id}" class="submitForm" id="saveCity" name="savedCityId" style="width: 0px;height: 0px;overflow: hidden; display: none;" onchange="form.submit()" >
                                                        </label>
                                                </form>
                                        </li>
                                        <li>
                                                <a class="btn btn-primary save-compare-btn"
                                                        th:href="@{'/compare/' + ${city.id}}"
                                                        role="button">Compare 2 Cities</a>
                                        </li>
                                </ul>

                        </div>
                </div>
        </div>
</div>

<!--<div class="card city-rating-card">
        <div class="card-body row">
                <div class="col-sm-6">
                        <p class="rating-category">Affordability</p>
                        <p class="rating-category">Safety</p>
                        <p class="rating-category">Transportation</p>
                        <p class="rating-category">Job Growth</p>
                        <p class="rating-category">Schools</p>
                </div>
                <div class="col-sm-6">
                        <div class="Stars" th:style="|--rating: ${affordabilityRating}|" ></div>
                        <div class="Stars" th:style="|--rating: ${safetyRating}|" ></div>
                        <div class="Stars" th:style="|--rating: ${transportationRating}|" ></div>
                        <div class="Stars" th:style="|--rating: ${jobGrowthRating}|" ></div>
                        <div class="Stars" th:style="|--rating: ${schoolRating}|" ></div>

                </div>
        </div>
</div>
-->

<div class="card city-rating-card">
        <div class="card-body row">
                <div class="col-sm-6">
                        <table>
                              <tr>
                                      <td class="rating-category" >Affordability</td>
                                      <td >
                                              <div class="Stars" th:style="|--rating: ${affordabilityRating}|" ></div>
                                      </td>
                              </tr>
                              <tr>
                                      <td class="rating-category">Safety</td>
                                      <td >
                                              <div class="Stars" th:style="|--rating: ${safetyRating}|" ></div>
                                        </td>
                              </tr>
                              <tr>
                                      <td class="rating-category">Transportation</td>

                                      <td>
                                              <div class="Stars" th:style="|--rating: ${transportationRating}|" ></div>
                                      </td>
                              </tr>
                              <tr>
                                      <td class="rating-category">Affordability</td>
                                      <td>
                                              <div class="Stars" th:style="|--rating: ${jobGrowthRating}|" ></div>
                                      </td>
                              </tr>

                        </table>
                </div>
        </div>
</div>

<div class="city-view-card">


        <h2 class="review-header"><a id="targetUserReviews">User Reviews</a></h2>

        <div class="dropdown" id="sort-by-dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="sort-by-dropdown-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Sort by:
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" th:href="@{'/view/' + ${city.id} + '/' + ${currentPage} + '?sortField=reviewDate&sortDirection=desc' + '#targetUserReviews'}">Most Recent</a>
                        <a class="dropdown-item" th:href="@{'/view/' + ${city.id} + '/' + ${currentPage} + '?sortField=reviewDate&sortDirection=asc' + '#targetUserReviews'}">Oldest</a>
                        <a class="dropdown-item" th:href="@{'/view/' + ${city.id} + '/' + ${currentPage} + '?sortField=overallRating&sortDirection=asc' + '#targetUserReviews'}">Highest Overall Rating</a>
                        <a class="dropdown-item" th:href="@{'/view/' + ${city.id} + '/' + ${currentPage} + '?sortField=overallRating&sortDirection=desc' + '#targetUserReviews'}">Lowest Overall Rating</a>
                </div>
        </div>

        <div class="row justify-content-center">
        <form class="col-xs-3" th:action="@{'/view/' + ${city.id} + '/1'+ '#targetUserReviews'}" method="get">
                <input type="text" class="search" id="searchTermForReviews1" name="searchTermForReviews" placeholder="Enter a search Term"/>
                <button type="submit" class="btn btn-primary" value="Search"  ><span>Search</span></button>
        </form>
        </div>

        <div class="container w-50 p-3">
        <div class="row justify-content-center">
        <div  class="btn-group" th:each="x :${#numbers.sequence(0,wordsForFilterReviews.length-1)}"  >
                <form th:action="@{'/view/' + ${city.id} + '/1'+ '#targetUserReviews'}" method="get">
                        <input type="hidden" class="search" th:value="${wordsForFilterReviews[x]}" id="searchTermForReviews" name="searchTermForReviews" placeholder="Enter a search Term"/>
                        <button type="submit" class="btn btn-outline-primary mr-1" value="Search" ><span th:text="${wordsForFilterReviews[x]}"></span></button>
                </form>
        </div>
        </div>
        </div>

        <div class="jumbotron review-display" th:if="${reviews.size()==0}">
                <h5>No reviews submitted yet.</h5>
                <a th:href="@{'/review/' + ${city.id}}" >Write a Review</a>
        </div>

        <div th:each="i : ${#numbers.sequence(reviews.size() -1, 0, -1)}">
                <th:block th:unless="${reviews[i].title=='' and reviews[i].comment==''}">
                        <div class="jumbotron review-display">
                                <h3>
                                    <p th:text = "${reviews[i].title}"></p>
                                </h3>

                                <div th:if="${searchTermForReviews == null || searchTermForReviews == ''}">
                                <p class="lead">
                                <p th:utext = "${reviews[i].comment}"></p>
                                </p>
                                </div>

                                <span th:each="j :${#numbers.sequence(0,wordListToHighlight.size()-1)}">
                                        <div th:if="${searchTermForReviews != null && searchTermForReviews != '' && reviews[i].comment.matches('(.* )?' + wordListToHighlight[j] + '( .*)?')}" >
                                                 <p class="lead">
                                                        <p th:utext="${reviews[i].comment.replace(wordListToHighlight[j], highlightWordStyle + wordListToHighlight[j] + '</span>')}"></p>
                                                 </p>
                                        </div>
                                </span>


                                <hr class="my-4">
                                <a class="review-date" th:href="@{/view-profile(userId=${reviews[i].getUser().id})}"
                                   th:text =
                                        "${reviews[i].getUser().username} + ' submitted the review on ' + ${reviews[i].reviewDate}"></a>
                                <p class="review-date" th:if="${reviews[i].getUser().equals(user)}">
                                        <a th:href="@{'/review/edit/' + ${reviews[i].id}}">Edit this review</a>
                                </p>
                        </div>
                </th:block>

        </div>



        <div th:if = "${totalPages > 1}">
                <div class="row">
                        <div class="col-lg-6 offset-lg-3 py-5 border">
                                <nav>
                                        <ul class="pagination justify-content-center flex-wrap">

                                                <li class="page-item">
                                                        <a class="page-link" th:if="${currentPage > 1}" th:href="@{'/view/' + ${city.id} + '/1' + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} + '#targetUserReviews'}">First</a>
                                                </li>
                                                <li class="page-item">
                                                        <a class="page-link" th:if="${currentPage > 1}" th:href="@{'/view/' + ${city.id} + '/' + ${currentPage - 1} + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} + '#targetUserReviews'}">Previous</a>
                                                        <!--                                                        <span th:unless="${currentPage < totalPages}"><a class="page-link">Previous</a></span>-->
                                                </li>

                                                <th:block th:if="${totalPages <= 10}">
                                                        <li class="page-item" th:each="i: ${#numbers.sequence(1, totalPages)}">
                                                                <a class="page-link" th:if="${currentPage != i}" th:href="@{'/view/' + ${city.id} + '/' + ${i} + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} + '#targetUserReviews'}">[[${i}]]</a>
                                                                <span th:unless="${currentPage != i }"><a class="page-link">[[${i}]]</a></span>

                                                        </li>
                                                </th:block>

                                                <th:block th:if="${totalPages > 10}">
                                                        <th:block th:if="${currentPage <= 5 || currentPage >= totalPages - 4}">
                                                                <li class="page-item" th:each="i: ${#numbers.sequence(1, 5)}">
                                                                        <a class="page-link" th:if="${currentPage != i}" th:href="@{'/view/' + ${city.id} + '/' + ${i} + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} + '#targetUserReviews'}">[[${i}]]</a>
                                                                        <span th:unless="${currentPage != i }"><a class="page-link">[[${i}]]</a></span>

                                                                </li>
                                                                <a th:href="@{'/page/' + 6 + '?searchTerm=' + ${searchTerm}}" class="page-link">...</a>

                                                                <li class="page-item" th:each="i: ${#numbers.sequence(totalPages -4 , totalPages)}" >
                                                                        <a class="page-link" th:if="${currentPage != i}" th:href="@{'/view/' + ${city.id} + '/' + ${i} + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} + '#targetUserReviews'}" >[[${i}]]</a>
                                                                        <span th:unless="${currentPage != i }"><a class="page-link">[[${i}]]</a></span>

                                                                </li>
                                                        </th:block>

                                                        <th:block th:if="${currentPage > 5 && currentPage < totalPages -4}">

                                                                <a th:href="@{'/view/' + ${city.id} + '/' + ${currentPage - 5} + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} +  '#targetUserReviews'}" class="page-link">...</a>

                                                                <li class="page-item" th:each="i: ${#numbers.sequence(currentPage -4 , currentPage + 4)}">
                                                                        <a class="page-link" th:if="${currentPage != i}" th:href="@{'/view/' + ${city.id} + '/' + ${i} + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} +'#targetUserReviews'}">[[${i}]]</a>
                                                                        <span th:unless="${currentPage != i }" ><a class="page-link">[[${i}]]</a></span>

                                                                </li>

                                                                <a th:href="@{'/view/' + ${city.id} + '/' + ${currentPage + 5} + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} + '#targetUserReviews'}" class="page-link">...</a>

                                                        </th:block>

                                                </th:block>

                                                <li class="page-item">
                                                        <a class="page-link" th:if="${currentPage < totalPages}" th:href="@{'/view/' + ${city.id} + '/' + ${currentPage + 1} + '?searchTermForReviews=' + ${searchTermForReviews} + '&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} +  '#targetUserReviews'}">Next</a>
                                                        <!--                                                        <span th:unless="${currentPage < totalPages}"><a class="page-link">Next</a></span>-->
                                                </li>

                                                <li class="page-item">
                                                        <a class="page-link" th:if="${currentPage < totalPages}" th:href="@{'/view/' + ${city.id} + '/' + ${totalPages} + '?searchTermForReviews=' + ${searchTermForReviews} +'&sortField=' + ${sortField} + '&sortDirection=' + ${sortDirection} + '#targetUserReviews'}">Last</a>
                                                        <!--                                                        <span th:unless="${currentPage < totalPages}"><a class="page-link">Last</a></span>-->
                                                </li>
                                        </ul>
                                </nav>
                        </div>
                </div>
        </div>


</div>







</body>
<div th:replace="fragments :: footer"></div>
</html>